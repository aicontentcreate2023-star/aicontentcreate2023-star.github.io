<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessions 搜索機制</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.8;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 4px solid #27ae60;
            padding-left: 15px;
        }
        h3 {
            color: #555;
            margin-top: 25px;
        }
        .version {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        .diagram {
            background: #ecf0f1;
            border-left: 4px solid #e74c3c;
            padding: 20px;
            margin: 25px 0;
            border-radius: 5px;
        }
        .diagram strong {
            color: #e74c3c;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            line-height: 1.5;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .warning {
            background: #ffe5e5;
            padding: 15px;
            border-left: 4px solid #e74c3c;
            margin: 20px 0;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
        }
        ul, ol {
            margin-left: 20px;
        }
        li {
            margin: 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #27ae60;
            color: white;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison > div {
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>💬 Sessions 搜索機制</h1>
    <div class="version">
        📄 版本：v1.0<br>
        🕒 最後更新：2026-02-09 17:40 GMT+8
    </div>

    <h2>一、什麼是 Sessions 搜索？</h2>
    <p>
        Sessions 搜索是 Memory Recall 的<strong>可選擴展功能</strong>，允許 AI 搜索：
    </p>
    <ul>
        <li>📜 完整的對話歷史（<code>sessions/*.jsonl</code>）</li>
        <li>🔍 跨 session 的語義搜索</li>
        <li>🧠 從舊對話中找回遺忘的細節</li>
    </ul>

    <div class="warning">
        <strong>⚠️ 為什麼是「可選」的？</strong><br>
        1. <strong>性能考量</strong> - Session 文件可能很大（幾 MB），索引耗時<br>
        2. <strong>隱私考量</strong> - 不是所有人都想永久索引所有對話<br>
        3. <strong>實驗性功能</strong> - 功能還在改進中，可能有 bug
    </div>

    <h2>二、默認 vs 啟用 Sessions</h2>
    <div class="comparison">
        <div style="background: #e3f2fd; border: 2px solid #2196f3;">
            <h3>默認配置（只搜索 memory）</h3>
            <pre>{
  "memoryRecall": {
    "enabled": true,
    "sources": ["memory"]
  }
}</pre>
            <p><strong>搜索範圍：</strong></p>
            <ul>
                <li>✅ MEMORY.md</li>
                <li>✅ memory/*.md</li>
                <li>❌ sessions/*.jsonl</li>
            </ul>
        </div>
        <div style="background: #fff3e0; border: 2px solid #ff9800;">
            <h3>啟用 Sessions 搜索</h3>
            <pre>{
  "memoryRecall": {
    "enabled": true,
    "sources": ["memory", "sessions"]
  },
  "experimental": {
    "sessionMemory": true
  }
}</pre>
            <p><strong>搜索範圍：</strong></p>
            <ul>
                <li>✅ MEMORY.md</li>
                <li>✅ memory/*.md</li>
                <li>✅ sessions/*.jsonl</li>
            </ul>
        </div>
    </div>

    <h2>三、搜索範圍對比</h2>
    <div class="diagram">
        <strong>🎨 [生圖 Prompt]:</strong><br>
        A Venn diagram showing two circles: "memory files" (smaller, left) and "session files" (larger, right). The memory circle contains "MEMORY.md" and "daily logs". The session circle contains "complete conversation history" and "all session transcripts". Use green for memory and orange for sessions. Clean, modern style.
    </div>

    <table>
        <tr>
            <th>特性</th>
            <th>memory/ 搜索</th>
            <th>sessions/ 搜索</th>
        </tr>
        <tr>
            <td>數據來源</td>
            <td>人工整理的記憶文件</td>
            <td>完整對話歷史（自動記錄）</td>
        </tr>
        <tr>
            <td>內容特點</td>
            <td>精選、摘要、結構化</td>
            <td>原始、完整、未過濾</td>
        </tr>
        <tr>
            <td>文件大小</td>
            <td>小（通常 &lt; 100 KB）</td>
            <td>大（可能 &gt; 1 MB）</td>
        </tr>
        <tr>
            <td>索引速度</td>
            <td>快（秒級）</td>
            <td>慢（分鐘級）</td>
        </tr>
        <tr>
            <td>搜索精度</td>
            <td>高（人工篩選過）</td>
            <td>中（包含噪音）</td>
        </tr>
        <tr>
            <td>隱私風險</td>
            <td>低（已脫敏）</td>
            <td>高（完整對話）</td>
        </tr>
    </table>

    <h2>四、何時需要 Sessions 搜索？</h2>
    <h3>✅ 適合啟用的場景</h3>
    <ul>
        <li>📚 <strong>研究型任務</strong> - 需要查找幾週前的技術討論細節</li>
        <li>🔍 <strong>審計需求</strong> - 需要追溯決策過程</li>
        <li>💼 <strong>個人助手</strong> - 單人使用，隱私無憂</li>
        <li>🧠 <strong>知識庫</strong> - 想要 AI 記住所有對話</li>
    </ul>

    <h3>❌ 不建議啟用的場景</h3>
    <ul>
        <li>⚡ <strong>性能敏感</strong> - 硬件配置低，索引會拖慢系統</li>
        <li>🔒 <strong>多人共享</strong> - 多人使用同一 Gateway，隱私風險高</li>
        <li>💰 <strong>成本敏感</strong> - Embedding API 調用量大</li>
        <li>🧪 <strong>測試環境</strong> - 頻繁重置，不需要長期記憶</li>
    </ul>

    <h2>五、啟用步驟</h2>
    <h3>步驟 1：修改配置</h3>
    <pre>gateway config.patch({
  "memoryRecall": {
    "enabled": true,
    "sources": ["memory", "sessions"]
  },
  "experimental": {
    "sessionMemory": true
  }
})</pre>

    <h3>步驟 2：重啟 Gateway</h3>
    <pre>gateway restart()</pre>

    <div class="success">
        <strong>✅ 自動觸發索引：</strong><br>
        重啟後，Clawdbot 會自動：
        <ul>
            <li>掃描所有 <code>sessions/*.jsonl</code> 文件</li>
            <li>計算每個文件的大小（Delta 追踪）</li>
            <li>對增量內容執行索引（Chunking + Embedding）</li>
        </ul>
    </div>

    <h3>步驟 3：驗證是否生效</h3>
    <pre># 檢查 SQLite 數據庫
ls -lh ~/.clawdbot/memory/main.sqlite

# 應該看到文件大小增加（說明已索引 sessions）</pre>

    <h2>六、搜索行為差異</h2>
    <h3>6.1 只搜索 memory（默認）</h3>
    <pre>memory_search("記事本社團最新貼文")

<strong>搜索範圍：</strong>
→ MEMORY.md
→ memory/2026-02-06.md
→ memory/2026-02-07.md
...

<strong>結果：</strong>
✅ 找到：memory/2026-02-06.md lines 125-140
（因為已經人工記錄過）</pre>

    <h3>6.2 搜索 memory + sessions（啟用後）</h3>
    <pre>memory_search("記事本社團最新貼文")

<strong>搜索範圍：</strong>
→ MEMORY.md
→ memory/2026-02-06.md
→ sessions/main.jsonl
→ sessions/sub-abc123.jsonl
...

<strong>結果：</strong>
✅ 找到：memory/2026-02-06.md lines 125-140
✅ 找到：sessions/main.jsonl chunk #42
  （原始對話：你："整理記事本社團貼文..."）</pre>

    <div class="highlight">
        <strong>💡 搜索策略：</strong><br>
        Clawdbot 會<strong>合併兩個來源的結果</strong>，按相關度排序。
        通常 memory 文件的片段會排在前面（因為已經過人工篩選）。
    </div>

    <h2>七、性能影響</h2>
    <h3>7.1 索引時間</h3>
    <table>
        <tr>
            <th>Session 文件大小</th>
            <th>Chunks 數量</th>
            <th>索引時間（估算）</th>
        </tr>
        <tr>
            <td>100 KB（~100 條對話）</td>
            <td>~10 chunks</td>
            <td>5-10 秒</td>
        </tr>
        <tr>
            <td>1 MB（~1,000 條對話）</td>
            <td>~100 chunks</td>
            <td>30-60 秒</td>
        </tr>
        <tr>
            <td>10 MB（~10,000 條對話）</td>
            <td>~1,000 chunks</td>
            <td>5-10 分鐘</td>
        </tr>
    </table>

    <h3>7.2 搜索時間</h3>
    <p>啟用 sessions 後，搜索時間增加不多（因為用向量索引）：</p>
    <ul>
        <li>只搜索 memory：~500 ms</li>
        <li>搜索 memory + sessions：~800 ms</li>
    </ul>

    <h3>7.3 存儲空間</h3>
    <pre># 檢查數據庫大小
ls -lh ~/.clawdbot/memory/main.sqlite

# 估算：
# - 10 個 session 文件（每個 1 MB）
# - 每個文件 ~100 chunks
# - 總共 ~1,000 chunks
# - 數據庫大小：~6 MB</pre>

    <h2>八、隱私考量</h2>
    <div class="warning">
        <strong>⚠️ 敏感信息風險：</strong><br>
        Sessions 搜索會索引<strong>完整對話歷史</strong>，包括：
        <ul>
            <li>🔑 API Keys、Tokens（如果曾經貼過）</li>
            <li>🔒 密碼、個人隱私信息</li>
            <li>💬 所有對話細節（包括已刪除的消息）</li>
        </ul>
    </div>

    <h3>建議做法：</h3>
    <ol>
        <li><strong>單人使用</strong> - 只在個人 Gateway 啟用</li>
        <li><strong>定期清理</strong> - 刪除舊 session 文件（避免永久索引）</li>
        <li><strong>審查數據</strong> - 檢查 SQLite 數據庫，確保無敏感信息</li>
    </ol>

    <h2>九、實驗性功能狀態</h2>
    <div class="highlight">
        <strong>🧪 為什麼是「實驗性」？</strong><br>
        1. <strong>功能還在完善</strong> - 可能有未發現的 bug<br>
        2. <strong>性能待優化</strong> - 大文件索引可能很慢<br>
        3. <strong>配置可能變更</strong> - 未來版本可能改變配置方式
    </div>

    <h3>已知問題：</h3>
    <ul>
        <li>⚠️ Sub-agent 無法使用 Sessions 搜索（因為 isMinimal 跳過 Memory Recall）</li>
        <li>⚠️ Delta 閾值較大（8 KB），可能延遲索引</li>
        <li>⚠️ 沒有 Session 年齡管理（舊 session 永久存在）</li>
    </ul>

    <h2>十、總結</h2>
    <ul>
        <li>✅ Sessions 搜索是<strong>可選功能</strong>，默認關閉</li>
        <li>✅ 啟用需要設置 <code>sources: ["memory", "sessions"]</code></li>
        <li>✅ 搜索範圍：完整對話歷史（sessions/*.jsonl）</li>
        <li>⚠️ 性能影響：索引慢（分鐘級），搜索快（毫秒級）</li>
        <li>⚠️ 隱私風險：完整對話被永久索引</li>
        <li>🧪 實驗性功能，可能有未知問題</li>
    </ul>

    <hr style="margin: 40px 0; border: none; border-top: 2px solid #ecf0f1;">
    <p style="text-align: center; color: #7f8c8d; font-size: 0.9em;">
        📚 Memory Recall 系列文檔 3/4<br>
        上一篇：<a href="memoryRecall_isMinimal.html">isMinimal 機制詳解</a><br>
        下一篇：<a href="memoryRecall_technical.html">Session Search 技術實作</a>
    </p>
</body>
</html>
