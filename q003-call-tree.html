<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q003 èª¿ç”¨æ¨¹åˆ†æ - testFinishBottom</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'SF Pro', -apple-system, system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
        }
        h1 {
            color: #1d1d1f;
            border-bottom: 3px solid #0071e3;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bug-marker {
            color: #ff3b30;
            font-weight: bold;
        }
        .pass-marker {
            color: #34c759;
            font-weight: bold;
        }
        .condition {
            background: #f0f0f5;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'SF Mono', monospace;
            font-size: 0.9em;
        }
        pre {
            background: #1d1d1f;
            color: #f5f5f7;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        code {
            font-family: 'SF Mono', monospace;
        }
        .timeline {
            border-left: 3px solid #0071e3;
            padding-left: 20px;
            margin: 20px 0;
        }
        .timeline-item {
            margin-bottom: 15px;
            position: relative;
        }
        .timeline-item::before {
            content: 'â—';
            position: absolute;
            left: -28px;
            color: #0071e3;
            font-size: 20px;
        }
        .old-bug {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .new-bug {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
        }
        .meta {
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š Q003 èª¿ç”¨æ¨¹åˆ†æï¼štestFinishBottom</h1>
    
    <div class="meta">
        <strong>ç‰ˆæœ¬ï¼š</strong> v1.0<br>
        <strong>æ›´æ–°æ™‚é–“ï¼š</strong> 2026-02-25 19:54 GMT+8<br>
        <strong>åˆ†æè€…ï¼š</strong> åšç‰¹ä¸€è™Ÿã€åšç‰¹å››è™Ÿ<br>
        <strong>ç›®çš„ï¼š</strong> æ‰¾å‡ºç‚ºä½•èˆŠ Bug ç„¡æ•ˆï¼Œè¨­è¨ˆæ–°çš„æœ‰æ•ˆ Bug
    </div>

    <div class="section">
        <h2>æ¸¬è©¦å ´æ™¯</h2>
        <p><code>testFinishBottom</code> æ¸¬è©¦åº•å±¤ Activity è¢«é ‚å±¤é®è“‹å¾Œ finish çš„ç”Ÿå‘½é€±æœŸï¼š</p>
        <ol>
            <li>å•Ÿå‹• FirstActivityï¼ˆåº•å±¤ï¼‰</li>
            <li>å•Ÿå‹• SecondActivityï¼ˆé ‚å±¤ï¼Œé®è“‹åº•å±¤ï¼‰</li>
            <li>ç­‰å¾… FirstActivity é€²å…¥ ON_STOP ç‹€æ…‹</li>
            <li><strong>å‘¼å« firstActivity.finish()</strong> â† æ¸¬è©¦çš„é‡é»</li>
            <li>ç­‰å¾… FirstActivity é€²å…¥ ON_DESTROY</li>
            <li>é©—è­‰ï¼šç”Ÿå‘½é€±æœŸåºåˆ—åªæœ‰ [ON_DESTROY]ï¼ˆæ²’æœ‰ ON_STOPï¼Œå› ç‚ºå·²ç¶“åœæ­¢ï¼‰</li>
        </ol>
    </div>

    <div class="section">
        <h2>å®Œæ•´èª¿ç”¨æ¨¹ï¼ˆå«æ‰€æœ‰åˆ†æ”¯ï¼‰</h2>
        <div class="mermaid">
graph TD
    A[testFinishBottom: firstActivity.finish] --> B[Activity.finish]
    B --> C[ActivityClient.finish]
    C --> D[ATMS.finishActivity]
    D --> E[ActivityRecord.completeFinishing]
    
    E --> F{isCurrentVisible?}
    F -->|true| G[å¯è¦‹ Activity åˆ†æ”¯]
    F -->|false âœ“| H[ä¸å¯è¦‹ Activity åˆ†æ”¯]
    
    G --> G1{isNextNotYetVisible<br/>æˆ– delayRemoval?}
    G1 -->|true| G2[addToStopping]
    G2 --> G3[setState STOPPING]
    G3 --> OLD[ğŸš« èˆŠ Bug ä½ç½®<br/>è¨»è§£æ‰ setState]
    G1 -->|false| G4[destroyImmediately]
    
    H --> H1[addToFinishingAndWaitForIdle]
    H1 --> H2[destroyIfPossible]
    
    H2 --> I{isLastRootTaskOverEmptyHome?<br/>next == null &&<br/>rootTask.isFocused &&<br/>hasHomeTask}
    I -->|true| I1[ä¸ç«‹å³ destroy]
    I1 --> I2[addToFinishingAndWaitForIdle]
    I -->|false âœ“| J[destroyImmediately]
    
    J --> K{nowVisible == false &&<br/>finishing == true?}
    K -->|true âœ“| L[ğŸ› æ–° Bug ç”Ÿæ•ˆ]
    K -->|false| M[æ­£å¸¸ç™¼é€ destroy äº‹å‹™]
    
    L --> L1[skipDestroy = true]
    L1 --> L2[è·³é scheduleTransactionItem]
    L2 --> L3[Activity ä¸æœƒæ”¶åˆ° onDestroy]
    L3 --> FAIL[âŒ æ¸¬è©¦ Fail<br/>Timeout æˆ– Assertion Error]
    
    M --> M1[scheduleTransactionItem<br/>DestroyActivityItem]
    M1 --> M2[Activity æ”¶åˆ° onDestroy]
    M2 --> PASS[âœ… æ¸¬è©¦ Pass]
    
    style F fill:#fff3cd
    style H fill:#d4edda
    style I fill:#fff3cd
    style J fill:#d4edda
    style K fill:#fff3cd
    style L fill:#ff6b6b,color:#fff
    style OLD fill:#ffc107,color:#000
    style FAIL fill:#ff3b30,color:#fff
    style PASS fill:#34c759,color:#fff
        </div>
    </div>

    <div class="section">
        <h2>é—œéµåˆ†æ”¯æ¢ä»¶åˆ†æ</h2>
        <div class="timeline">
            <div class="timeline-item">
                <h3>æ¢ä»¶ 1: isCurrentVisible</h3>
                <p><span class="condition">isCurrentVisible = false</span></p>
                <p><strong>åŸå› ï¼š</strong> FirstActivity è¢« SecondActivity é®è“‹ï¼Œä¸å¯è¦‹</p>
                <p><strong>çµæœï¼š</strong> èµ° <code>else</code> åˆ†æ”¯ â†’ <code>addToFinishingAndWaitForIdle()</code></p>
            </div>
            
            <div class="timeline-item">
                <h3>æ¢ä»¶ 2: isLastRootTaskOverEmptyHome</h3>
                <p><span class="condition">next = SecondActivity (é null)</span></p>
                <p><span class="condition">isLastRootTaskOverEmptyHome = false</span></p>
                <p><strong>åŸå› ï¼š</strong> é‚„æœ‰ SecondActivity åœ¨ä¸Šå±¤ï¼Œä¸æ˜¯æœ€å¾Œä¸€å€‹ Activity</p>
                <p><strong>çµæœï¼š</strong> ç›´æ¥å‘¼å« <code>destroyImmediately()</code></p>
            </div>
            
            <div class="timeline-item">
                <h3>æ¢ä»¶ 3: nowVisible && finishing</h3>
                <p><span class="condition">nowVisible = false</span>ï¼ˆè¢«é®è“‹ï¼‰</p>
                <p><span class="condition">finishing = true</span>ï¼ˆæ­£åœ¨ finishï¼‰</p>
                <p><strong>Bug æ¢ä»¶ï¼š</strong> <code>!nowVisible && finishing</code> â†’ <span class="bug-marker">true</span></p>
                <p><strong>çµæœï¼š</strong> <code>skipDestroy = true</code>ï¼Œè·³éç™¼é€ destroy äº‹å‹™</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ç‚ºä»€éº¼èˆŠ Bug ç„¡æ•ˆï¼Ÿ</h2>
        <div class="old-bug">
            <h3>ğŸš« èˆŠ Bug ä½ç½®</h3>
            <pre><code>// åœ¨ completeFinishing() ä¸­
if (isCurrentVisible) {
    if (isNextNotYetVisible || delayRemoval) {
        addToStopping(false, false);
        // setState(STOPPING, "completeFinishing");  â† èˆŠ Bugï¼šè¨»è§£æ‰é€™è¡Œ
    }
}</code></pre>
            <p><strong>å•é¡Œï¼š</strong></p>
            <ul>
                <li><span class="bug-marker">æ¢ä»¶ä¸ç¬¦åˆï¼š</span> <code>isCurrentVisible = false</code>ï¼ˆActivity è¢«é®è“‹ï¼‰</li>
                <li>æ¸¬è©¦æ°¸é ä¸æœƒèµ°åˆ° <code>if (isCurrentVisible)</code> é€™å€‹åˆ†æ”¯</li>
                <li>Bug ä»£ç¢¼å®Œå…¨æ²’æœ‰åŸ·è¡Œ â†’ æ¸¬è©¦ Pass</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>æ–° Bug è¨­è¨ˆ</h2>
        <div class="new-bug">
            <h3>âœ… æ–° Bug ä½ç½®</h3>
            <pre><code>// åœ¨ destroyImmediately() ä¸­ï¼ˆè¡Œ 4063ï¼‰
boolean destroyImmediately(String reason) {
    ...
    final boolean nowVisible = mVisibleRequested && mVisible;
    
    // ğŸ› æ–° Bugï¼šéŒ¯èª¤åœ°è·³éä¸å¯è¦‹ Activity çš„ destroy
    if (!nowVisible && finishing) {
        return false;  // è·³éå¾ŒçºŒçš„ scheduleTransactionItem
    }
    
    if (hasProcess()) {
        mAtmService.mH.post(() -> {
            try {
                mAtmService.getLifecycleManager()
                    .scheduleTransactionItem(app.getThread(),
                        DestroyActivityItem.obtain(...));  // â† é€™è¡Œä¸æœƒåŸ·è¡Œ
            } catch (Exception e) { ... }
        });
    }
    ...
}</code></pre>
            <p><strong>ç‚ºä»€éº¼æœ‰æ•ˆï¼š</strong></p>
            <ul>
                <li><span class="pass-marker">æ¢ä»¶ç¬¦åˆï¼š</span> <code>nowVisible = false && finishing = true</code></li>
                <li>æ¸¬è©¦å ´æ™¯ä¸‹æœƒåŸ·è¡Œåˆ°é€™å€‹åˆ†æ”¯</li>
                <li>è·³é <code>scheduleTransactionItem</code> â†’ Activity ä¸æœƒæ”¶åˆ° <code>onDestroy()</code></li>
                <li>æ¸¬è©¦çš„ <code>waitAndAssertActivityStates(ON_DESTROY)</code> æœƒ timeout/fail</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>Lesson Learned</h2>
        <h3>é¸æ³¨å…¥é»çš„æ–°æ¨™æº–</h3>
        <ol>
            <li><strong>ç•«å‡ºå®Œæ•´åˆ†æ”¯åœ–</strong> â€” ä¸åªæ˜¯å‡½æ•¸èª¿ç”¨ï¼Œé‚„è¦åŒ…å«æ‰€æœ‰ if/else åˆ†æ”¯</li>
            <li><strong>æ¨¡æ“¬æ¸¬è©¦å ´æ™¯</strong> â€” ç¢ºå®šæ¸¬è©¦åœ¨é€™å€‹å ´æ™¯ä¸‹æœƒèµ°å“ªå€‹åˆ†æ”¯</li>
            <li><strong>é©—è­‰æ¢ä»¶å€¼</strong> â€” ç¢ºèª if æ¢ä»¶åœ¨æ¸¬è©¦å ´æ™¯ä¸‹çš„å€¼ï¼ˆtrue/falseï¼‰</li>
            <li><strong>ç¢ºèª Bug æœƒåŸ·è¡Œ</strong> â€” Bug å¿…é ˆåœ¨æ¸¬è©¦åŸ·è¡Œè·¯å¾‘ä¸Šï¼Œä¸èƒ½åœ¨ä¸æœƒèµ°åˆ°çš„åˆ†æ”¯</li>
            <li><strong>é©—è­‰ Bug å½±éŸ¿æ¸¬è©¦</strong> â€” Bug å½±éŸ¿çš„è¡Œç‚º = æ¸¬è©¦ assertion æª¢æŸ¥çš„è¡Œç‚º</li>
        </ol>
        
        <h3>Q003 é©—è­‰çš„éŒ¯èª¤æ¨¡å¼</h3>
        <ul>
            <li>âŒ åªçœ‹å‡½æ•¸åç¨±ï¼ˆ<code>completeFinishing()</code> æœƒè¢«èª¿ç”¨ï¼‰</li>
            <li>âŒ æ²’æœ‰åˆ†æåˆ†æ”¯æ¢ä»¶ï¼ˆ<code>isCurrentVisible</code> çš„å€¼ï¼‰</li>
            <li>âŒ é‡è¤‡é©—è­‰æœŸå¾…ä¸åŒçµæœ</li>
            <li>âœ… æ‡‰è©²å…ˆç•«åˆ†æ”¯åœ–ï¼Œç¢ºèªèª¿ç”¨è·¯å¾‘ï¼Œå†è¨­è¨ˆ Bug</li>
        </ul>
    </div>

    <div class="section">
        <h2>é æœŸé©—è­‰çµæœ</h2>
        <p><strong>æ¸¬è©¦åŸ·è¡Œæµç¨‹ï¼š</strong></p>
        <ol>
            <li>ç·¨è­¯å¥—ç”¨æ–° Bug çš„ AOSP</li>
            <li>Flash åˆ°æ¸¬è©¦è¨­å‚™</li>
            <li>åŸ·è¡Œ <code>CtsWindowManagerDeviceTestCases</code> ä¸­çš„ <code>ActivityLifecycleTests#testFinishBottom</code></li>
            <li><strong>é æœŸçµæœï¼š</strong> <span class="bug-marker">æ¸¬è©¦ FAIL</span></li>
            <li><strong>å¤±æ•—åŸå› ï¼š</strong> Timeout æˆ– Assertion Errorï¼ˆç­‰ä¸åˆ° ON_DESTROYï¼‰</li>
        </ol>
        
        <p><strong>å¦‚æœæ¸¬è©¦é‚„æ˜¯ Passï¼š</strong></p>
        <ul>
            <li>è¡¨ç¤ºèª¿ç”¨è·¯å¾‘åˆ†æé‚„æ˜¯æœ‰èª¤</li>
            <li>éœ€è¦åŠ  log è¿½è¹¤å¯¦éš›åŸ·è¡Œè·¯å¾‘</li>
            <li>æˆ–ç”¨ method tracing å‹•æ…‹é©—è­‰</li>
        </ul>
    </div>

    <div class="meta">
        <p><strong>æ–‡ä»¶ç”Ÿæˆæ™‚é–“ï¼š</strong> 2026-02-25 19:54 GMT+8</p>
        <p><strong>è‡¨æ™‚é é¢ï¼š</strong> 3 å°æ™‚å¾Œè‡ªå‹•ä¸‹æ¶</p>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
