<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIS-H001 Android CTS è§£é¡Œåˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header .meta {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        h2 {
            color: #667eea;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }
        
        h3 {
            color: #764ba2;
            margin: 30px 0 15px 0;
            font-size: 1.4em;
        }
        
        .error-box {
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .error-box code {
            background: #fed7d7;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .success-box {
            background: #f0fff4;
            border-left: 4px solid #38a169;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .code-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
        }
        
        .code-block h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .code-block.correct {
            border: 2px solid #38a169;
        }
        
        .code-block.buggy {
            border: 2px solid #e53e3e;
        }
        
        .code-block pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .highlight {
            background: rgba(56, 161, 105, 0.3);
            padding: 2px 0;
        }
        
        .missing {
            background: rgba(229, 62, 62, 0.3);
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .flow-diagram {
            margin: 30px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .patch-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .patch-box .add {
            color: #38a169;
        }
        
        .patch-box .remove {
            color: #e53e3e;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .summary-box h3 {
            color: white;
            border-bottom: 2px solid white;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .timeline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .timeline-item {
            background: #edf2f7;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .timeline-arrow {
            color: #667eea;
            font-size: 1.5em;
        }
        
        @media (max-width: 768px) {
            .code-compare {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” DIS-H001 Android CTS è§£é¡Œåˆ†æ</h1>
            <div class="meta">
                <strong>æ¸¬è©¦æ¡ˆä¾‹ï¼š</strong> VirtualDisplayTest#testUntrustedSysDecorVirtualDisplay<br>
                <strong>é›£åº¦ï¼š</strong> Hard â­â­â­ | <strong>è§£é¡Œæ—¥æœŸï¼š</strong> 2026-02-23
            </div>
        </header>

        <div class="content">
            <!-- å•é¡Œæ¦‚è¿° -->
            <h2>ğŸ“‹ å•é¡Œæ¦‚è¿°</h2>
            <div class="error-box">
                <h3>âŒ éŒ¯èª¤ç¾è±¡</h3>
                <p><strong>éŒ¯èª¤é¡å‹ï¼š</strong> <code>SecurityException</code></p>
                <p><strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong> Requires INTERNAL_SYSTEM_WINDOW permission</p>
                <p><strong>ç™¼ç”Ÿä½ç½®ï¼š</strong> DisplayManager.createVirtualDisplay()</p>
                <pre style="margin-top: 10px; padding: 10px; background: #fed7d7; border-radius: 4px;">
java.lang.SecurityException: Requires INTERNAL_SYSTEM_WINDOW permission
  at android.os.Parcel.createExceptionOrNull(Parcel.java:3057)
  at android.hardware.display.DisplayManager.createVirtualDisplay(...)</pre>
            </div>

            <!-- æ¸¬è©¦é æœŸè¡Œç‚º -->
            <h2>ğŸ¯ æ¸¬è©¦é æœŸè¡Œç‚º</h2>
            <h3>CTS æ¸¬è©¦ä»£ç¢¼</h3>
            <div class="code-block">
                <pre><code>public void testUntrustedSysDecorVirtualDisplay() {
    // æ•…æ„ä¸è¨­ç½® TRUSTED flagï¼Œä½†è¨­ç½® SHOULD_SHOW_SYSTEM_DECORATIONS
    int flags = VIRTUAL_DISPLAY_FLAG_PUBLIC
              | VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY
              | VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS;  // âš ï¸ æ²’æœ‰ TRUSTED
    
    VirtualDisplay vd = mDisplayManager.createVirtualDisplay(..., flags, ...);
    
    // æ¸¬è©¦é æœŸï¼šå‰µå»ºæ‡‰è©²æˆåŠŸï¼Œä½† flag æœƒè¢«è‡ªå‹•æ¸…é™¤
    assertNotNull("VirtualDisplay should not be null", vd);
}</code></pre>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>é æœŸè¡Œç‚º</th>
                        <th>å¯¦éš›è¡Œç‚º</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>createVirtualDisplay</td>
                        <td>âœ… æˆåŠŸ</td>
                        <td>âŒ æ‹‹å‡º SecurityException</td>
                    </tr>
                    <tr>
                        <td>SHOULD_SHOW_SYSTEM_DECORATIONS flag</td>
                        <td>âœ… è¢«ç³»çµ±è‡ªå‹•æ¸…é™¤</td>
                        <td>âŒ æœªè¢«æ¸…é™¤ï¼Œè§¸ç™¼æ¬Šé™æª¢æŸ¥</td>
                    </tr>
                </tbody>
            </table>

            <!-- ä»£ç¢¼å°æ¯” -->
            <h2>ğŸ” ä»£ç¢¼å°æ¯”åˆ†æ</h2>
            <p><strong>å•é¡Œæ–‡ä»¶ï¼š</strong> <code>frameworks/base/services/core/java/com/android/server/display/DisplayManagerService.java</code></p>

            <div class="code-compare">
                <div class="code-block correct">
                    <h4>âœ… å®˜æ–¹ AOSPï¼ˆæ­£ç¢ºï¼‰</h4>
                    <pre><code><span class="highlight">// é—œéµï¼šå…ˆæª¢æŸ¥ TRUSTED flag
if ((flags & VIRTUAL_DISPLAY_FLAG_TRUSTED) == 0) {
    flags &= ~VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS;
}</span>

// ç„¶å¾Œæ‰æ¬Šé™æª¢æŸ¥
if ((flags & VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS) != 0) {
    if (!canProjectVideo(projection)) {
        throw new SecurityException("Requires INTERNAL_SYSTEM_WINDOW permission");
    }
}</code></pre>
                </div>

                <div class="code-block buggy">
                    <h4>âŒ project_sourceï¼ˆæœ‰ Bugï¼‰</h4>
                    <pre><code><span class="missing">// âš ï¸ ç¼ºå°‘ flag è‡ªå‹•æ¸…é™¤é‚è¼¯
if ((flags & VIRTUAL_DISPLAY_FLAG_TRUSTED) == 0) {
    flags &= ~VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS;
}</span>

// ç›´æ¥é€²å…¥æ¬Šé™æª¢æŸ¥ â†’ æ‹‹ç•°å¸¸
if ((flags & VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS) != 0) {
    if (!canProjectVideo(projection)) {
        throw new SecurityException("Requires INTERNAL_SYSTEM_WINDOW permission");
    }
}</code></pre>
                </div>
            </div>

            <!-- åŸ·è¡Œæµç¨‹å°æ¯” -->
            <h2>ğŸ“Š åŸ·è¡Œæµç¨‹å°æ¯”</h2>
            <div class="flow-diagram">
                <h3>å®˜æ–¹ AOSPï¼ˆæ­£ç¢ºæµç¨‹ï¼‰</h3>
                <div class="mermaid">
graph LR
    A[æ”¶åˆ° flags] --> B{æœ‰ TRUSTED flag?}
    B -->|å¦| C[æ¸…é™¤ SHOULD_SHOW_SYSTEM_DECORATIONS]
    B -->|æ˜¯| D[ä¿ç•™ flag]
    C --> E{æª¢æŸ¥æ¬Šé™}
    D --> E
    E -->|flag å·²æ¸…é™¤| F[âœ… å‰µå»ºæˆåŠŸ]
    E -->|æœ‰ flag + æœ‰æ¬Šé™| F
    E -->|æœ‰ flag + ç„¡æ¬Šé™| G[âŒ æ‹‹ç•°å¸¸]
    
    style F fill:#9ae6b4
    style G fill:#fc8181
                </div>
            </div>

            <div class="flow-diagram" style="margin-top: 20px;">
                <h3>project_sourceï¼ˆBug æµç¨‹ï¼‰</h3>
                <div class="mermaid">
graph LR
    A[æ”¶åˆ° flags] --> B[è·³éæª¢æŸ¥]
    B --> C{æª¢æŸ¥æ¬Šé™}
    C -->|æœ‰ flag + ç„¡æ¬Šé™| D[âŒ æ‹‹ç•°å¸¸]
    
    style D fill:#fc8181
                </div>
            </div>

            <!-- ä¿®å¾©æ–¹æ¡ˆ -->
            <h2>ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ</h2>
            <h3>Patch å…§å®¹</h3>
            <div class="patch-box">
<span class="add">+        if ((flags & VIRTUAL_DISPLAY_FLAG_TRUSTED) == 0) {
+            flags &= ~VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS;
+        }
+</span>
         // Sometimes users can have sensitive information...
         if ((flags & VIRTUAL_DISPLAY_FLAG_SHOULD_SHOW_SYSTEM_DECORATIONS) != 0) {
             if (!canProjectVideo(projection)) {
                 throw new SecurityException("Requires INTERNAL_SYSTEM_WINDOW permission");
             }
         }
            </div>

            <h3>ä¿®å¾©ä½ç½®</h3>
            <ul style="margin-left: 20px; line-height: 2;">
                <li><strong>æ–‡ä»¶ï¼š</strong> DisplayManagerService.java</li>
                <li><strong>è¡Œè™Ÿï¼š</strong> ç´„ç¬¬ 1595 è¡Œï¼ˆåœ¨æ¬Šé™æª¢æŸ¥çš„è¨»è§£ä¹‹å‰ï¼‰</li>
                <li><strong>ä¿®æ”¹ï¼š</strong> æ–°å¢ 4 è¡Œä»£ç¢¼</li>
            </ul>

            <!-- é©—è­‰çµæœ -->
            <h2>âœ… é©—è­‰çµæœ</h2>
            <div class="success-box">
                <h3>ç·¨è­¯æˆåŠŸ</h3>
                <p>âœ… build completed successfully (16:15 mm:ss)</p>
            </div>

            <div class="success-box">
                <h3>CTS æ¸¬è©¦é€šé</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æ¸¬è©¦æ¨¡çµ„</th>
                            <th>çµæœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CtsDisplayTestCases</td>
                            <td style="color: #38a169; font-weight: bold;">âœ… PASS</td>
                        </tr>
                        <tr>
                            <td>CtsDisplayTestCases[instant]</td>
                            <td style="color: #38a169; font-weight: bold;">âœ… PASS</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>Summary:</strong> pass="2" failed="0"</p>
            </div>

            <!-- è§£é¡Œé‚è¼¯éˆ -->
            <h2>ğŸ”— è§£é¡Œé‚è¼¯éˆ</h2>
            <div class="timeline">
                <div class="timeline-item">SecurityException éŒ¯èª¤</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">å®šä½æ¬Šé™æª¢æŸ¥ä»£ç¢¼</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">åˆ†ææ¸¬è©¦é æœŸ</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">å°æ¯”å®˜æ–¹ AOSP</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">ç™¼ç¾ç¼ºå°‘ flag æ¸…é™¤é‚è¼¯</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">è£œä¸Š 4 è¡Œä»£ç¢¼</div>
                <div class="timeline-arrow">â†’</div>
                <div class="timeline-item">âœ… é©—è­‰é€šé</div>
            </div>

            <!-- ç¸½çµ -->
            <div class="summary-box">
                <h3>ğŸ“ ç¸½çµ</h3>
                <p><strong>æ ¹å› ï¼š</strong> DisplayManagerService.java ç¼ºå°‘ TRUSTED flag æª¢æŸ¥å’Œè‡ªå‹•æ¸…é™¤é‚è¼¯</p>
                <p><strong>ä¿®å¾©ï¼š</strong> æ–°å¢ 4 è¡Œä»£ç¢¼ï¼Œåœ¨æ¬Šé™æª¢æŸ¥å‰å…ˆæª¢æŸ¥ TRUSTED flagï¼Œè‹¥ç„¡å‰‡æ¸…é™¤ SHOULD_SHOW_SYSTEM_DECORATIONS flag</p>
                <p><strong>è¨­è¨ˆæ„åœ–ï¼š</strong> å®‰å…¨è€ƒé‡ä¸‹ï¼Œå°æ–¼ä¸å—ä¿¡ä»»çš„ Appï¼Œç³»çµ±æœƒè‡ªå‹•æ‹’çµ•é¡¯ç¤ºç³»çµ±è£é£¾çª—å£çš„è«‹æ±‚ï¼Œä½†ä¸æœƒç›´æ¥æ‹‹ç•°å¸¸å°è‡´å‰µå»ºå¤±æ•—</p>
                
                <h3 style="margin-top: 30px;">â±ï¸ è€—æ™‚çµ±è¨ˆ</h3>
                <ul style="list-style: none; padding: 0;">
                    <li>ğŸ“Š åˆ†æå®šä½ï¼š5 åˆ†é˜</li>
                    <li>ğŸ”¨ ç·¨è­¯ï¼š16 åˆ†é˜</li>
                    <li>ğŸ“± åˆ·æ©Ÿæ¸¬è©¦ï¼š9 åˆ†é˜</li>
                    <li><strong>ğŸ¯ ç¸½è¨ˆï¼šç´„ 30 åˆ†é˜</strong></li>
                </ul>

                <h3 style="margin-top: 30px;">ğŸ’¡ é—œéµæŠ€å·§</h3>
                <ol style="margin-left: 20px; line-height: 2;">
                    <li>å¾éŒ¯èª¤è¨Šæ¯åæ¨ï¼šSecurityException ç›´æ¥æŒ‡å‘æ¬Šé™æª¢æŸ¥ä»£ç¢¼</li>
                    <li>ç†è§£æ¸¬è©¦æ„åœ–ï¼šæ¸¬è©¦åç¨±æš—ç¤ºæ¸¬è©¦ã€Œä¸ä¿¡ä»»çš„ App è«‹æ±‚ç³»çµ±è£é£¾ã€å ´æ™¯</li>
                    <li>å°æ¯”å®˜æ–¹ä»£ç¢¼ï¼šç›´æ¥æ¯”è¼ƒå®˜æ–¹ AOSP æ‰¾å‡ºå·®ç•°</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
