<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Search æŠ€è¡“å¯¦ä½œæ·±æŒ–</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.8;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }
        h3 {
            color: #555;
            margin-top: 25px;
        }
        .version {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        .diagram {
            background: #ecf0f1;
            border-left: 4px solid #e74c3c;
            padding: 20px;
            margin: 25px 0;
            border-radius: 5px;
        }
        .diagram strong {
            color: #e74c3c;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            line-height: 1.5;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .warning {
            background: #ffe5e5;
            padding: 15px;
            border-left: 4px solid #e74c3c;
            margin: 20px 0;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
        }
        ul, ol {
            margin-left: 20px;
        }
        li {
            margin: 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #e74c3c;
            color: white;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .flowchart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Session Search æŠ€è¡“å¯¦ä½œæ·±æŒ–</h1>
    <div class="version">
        ğŸ“„ ç‰ˆæœ¬ï¼šv1.0<br>
        ğŸ•’ æœ€å¾Œæ›´æ–°ï¼š2026-02-09 17:40 GMT+8
    </div>

    <div class="warning">
        <strong>âš ï¸ æœ¬æ–‡æª”æŠ€è¡“æ·±åº¦è¼ƒé«˜</strong><br>
        é©åˆï¼šé–‹ç™¼è€…ã€ç³»çµ±ç®¡ç†å“¡ã€æ·±åº¦ç”¨æˆ¶<br>
        å¦‚æœåªæƒ³äº†è§£åŸºæœ¬ä½¿ç”¨ï¼Œè«‹é–±è®€å‰ä¸‰ç¯‡æ–‡æª”ã€‚
    </div>

    <h2>ä¸€ã€å®Œæ•´æ•¸æ“šæµç¨‹åœ–</h2>
    <div class="diagram">
        <strong>ğŸ¨ [ç”Ÿåœ– Prompt]:</strong><br>
        A detailed technical flowchart showing the complete Session Search data pipeline. Start with "Session File (.jsonl)" â†’ "File Watcher" â†’ "Delta Tracker" â†’ "Debounce (300ms)" â†’ "Threshold Check (8KB)" â†’ "Parser" â†’ "Chunker (512 tokens)" â†’ "Gemini Embedding" â†’ "SQLite (3 tables)" â†’ "Search Engine". Use different colors for each stage. Include icons for files, database, and API calls. Modern, technical diagram style.
    </div>

    <div class="flowchart">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session Search å®Œæ•´æ•¸æ“šæµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å°è©±ç™¼ç”Ÿ
   â†“
2. å¯«å…¥ sessions/main.jsonlï¼ˆè‡ªå‹•ï¼‰
   â†“
3. onSessionTranscriptUpdate äº‹ä»¶è§¸ç™¼
   â†“
4. scheduleSessionDirty() [300ms é˜²æŠ–]
   â†“
5. processSessionDeltaBatch()
   â”œâ”€ è¨ˆç®— Deltaï¼ˆç•¶å‰å¤§å° - ä¸Šæ¬¡ç´¢å¼•å¤§å°ï¼‰
   â”œâ”€ æª¢æŸ¥é–¾å€¼ï¼š>= 8KB æˆ– >= 10 æ¢æ¶ˆæ¯ï¼Ÿ
   â””â”€ æ˜¯ â†’ ç¹¼çºŒ  /  å¦ â†’ è·³é
       â†“
6. syncSessionFiles()
   â”œâ”€ è®€å– .jsonl æ–‡ä»¶
   â”œâ”€ è§£æ JSONL â†’ æå–å°è©±æ–‡æœ¬
   â”œâ”€ åˆ†å¡Šï¼ˆ512 tokens/å¡Šï¼Œ64 tokens é‡ç–Šï¼‰
   â”œâ”€ èª¿ç”¨ Gemini Embedding API
   â”œâ”€ ç”Ÿæˆ 768 ç¶­å‘é‡
   â”œâ”€ å­˜å…¥ SQLite
   â”‚   â”œâ”€ files è¡¨ï¼ˆæ–‡ä»¶å…ƒæ•¸æ“šï¼‰
   â”‚   â”œâ”€ chunks è¡¨ï¼ˆæ–‡æœ¬ç‰‡æ®µï¼‰
   â”‚   â””â”€ vec0 è¡¨ï¼ˆå‘é‡ç´¢å¼•ï¼‰
   â””â”€ å®Œæˆ

7. ç”¨æˆ¶åŸ·è¡Œ memory_search()
   â†“
8. æŸ¥è©¢ embeddingï¼ˆGemini APIï¼‰
   â†“
9. å‘é‡æœç´¢ï¼ˆSQLite vec0 è¡¨ï¼‰
   â†“
10. é—œéµè©æœç´¢ï¼ˆFTS5ï¼‰
   â†“
11. RRF åˆä½µå…©å€‹çµæœ
   â†“
12. è¿”å› top-5 çµæœ</div>

    <h2>äºŒã€æ ¸å¿ƒçµ„ä»¶è§£æ</h2>
    <h3>2.1 æ–‡ä»¶ç›£è½å™¨ï¼ˆFile Watcherï¼‰</h3>
    <p>æºç¢¼ï¼š<code>src/memory/session-memory.ts</code></p>
    <pre>// ç›£è½ session æ–‡ä»¶è®Šæ›´
this.sessionStore.on('sessionTranscriptUpdate', (data) => {
  this.scheduleSessionDirty(data.sessionKey);
});</pre>

    <div class="success">
        <strong>âœ… äº‹ä»¶é©…å‹•è¨­è¨ˆï¼š</strong><br>
        æ¯æ¬¡å°è©±æ›´æ–°æ™‚è‡ªå‹•è§¸ç™¼ï¼Œç„¡éœ€æ‰‹å‹•åŒæ­¥ã€‚
    </div>

    <h3>2.2 Delta è¿½è¸ªå™¨ï¼ˆDelta Trackerï¼‰</h3>
    <p>æºç¢¼ï¼š<code>processSessionDeltaBatch()</code></p>
    <pre>const delta = currentSize - lastSize;

// é–¾å€¼åˆ¤æ–·
if (delta >= SESSION_INDEX_THRESHOLD) {
  // SESSION_INDEX_THRESHOLD = 8192 (8 KB)
  await this.syncSessionFiles([sessionKey]);
}</pre>

    <div class="highlight">
        <strong>ğŸ’¡ ç‚ºä»€éº¼ç”¨ Delta è€Œä¸æ˜¯å…¨é‡åŒæ­¥ï¼Ÿ</strong><br>
        â€¢ å…¨é‡åŒæ­¥ï¼šæ¯æ¬¡è®Šæ›´éƒ½é‡æ–°ç´¢å¼•æ•´å€‹æ–‡ä»¶ â†’ è¶Šä¾†è¶Šæ…¢<br>
        â€¢ Delta åŒæ­¥ï¼šåªåœ¨å¢é•· >= 8KB æ™‚æ‰ç´¢å¼• â†’ å¹³è¡¡å¯¦æ™‚æ€§å’Œæ€§èƒ½
    </div>

    <h3>2.3 é˜²æŠ–è™•ç†ï¼ˆDebounceï¼‰</h3>
    <pre>scheduleSessionDirty(sessionKey: string) {
  // 300ms å…§å¤šæ¬¡è®Šæ›´åªè§¸ç™¼ä¸€æ¬¡
  debounce(() => {
    this.processSessionDeltaBatch();
  }, 300);
}</pre>

    <table>
        <tr>
            <th>å ´æ™¯</th>
            <th>ç„¡é˜²æŠ–</th>
            <th>æœ‰é˜²æŠ–ï¼ˆ300msï¼‰</th>
        </tr>
        <tr>
            <td>å¿«é€Ÿå°è©±ï¼ˆ10 æ¢æ¶ˆæ¯ï¼‰</td>
            <td>è§¸ç™¼ 10 æ¬¡ç´¢å¼•</td>
            <td>è§¸ç™¼ 1 æ¬¡ç´¢å¼•</td>
        </tr>
        <tr>
            <td>API èª¿ç”¨é‡</td>
            <td>é«˜</td>
            <td>ä½</td>
        </tr>
        <tr>
            <td>ç³»çµ±è² è¼‰</td>
            <td>é«˜</td>
            <td>ä½</td>
        </tr>
    </table>

    <h2>ä¸‰ã€Session æ–‡ä»¶è§£æ</h2>
    <h3>3.1 JSONL æ ¼å¼</h3>
    <pre>// sessions/main.jsonl
{"role":"user","content":"ä½ å¥½"}
{"role":"assistant","content":"ä½ å¥½ï¼æœ‰ä»€éº¼å¯ä»¥å¹«ä½ çš„ï¼Ÿ"}
{"role":"user","content":"è¨˜äº‹æœ¬ç¤¾åœ˜æœ€æ–°è²¼æ–‡æ•´ç†å¥½äº†å—ï¼Ÿ"}</pre>

    <h3>3.2 è§£æé‚è¼¯</h3>
    <pre>function parseSessionTranscript(jsonlPath: string): string {
  const lines = readFileSync(jsonlPath, 'utf-8').split('\n');
  const messages = lines
    .filter(line => line.trim())
    .map(line => JSON.parse(line));

  // æå–å°è©±æ–‡æœ¬
  return messages
    .map(msg => `${msg.role}: ${msg.content}`)
    .join('\n\n');
}</pre>

    <h2>å››ã€Chunking ç­–ç•¥</h2>
    <div class="diagram">
        <strong>ğŸ¨ [ç”Ÿåœ– Prompt]:</strong><br>
        A visual representation of text chunking with overlap. Show a long text document being split into 3 chunks of 512 tokens each, with 64-token overlaps highlighted in yellow between chunks. Use a horizontal layout with arrows showing the flow. Clean, educational infographic style.
    </div>

    <h3>4.1 ç‚ºä»€éº¼éœ€è¦ Chunkingï¼Ÿ</h3>
    <ul>
        <li>ğŸ“ <strong>Embedding æ¨¡å‹é™åˆ¶</strong> - Gemini æœ€å¤§è¼¸å…¥ 2048 tokens</li>
        <li>ğŸ¯ <strong>æé«˜æª¢ç´¢ç²¾åº¦</strong> - å°ç‰‡æ®µæ›´å®¹æ˜“åŒ¹é…ç²¾ç¢ºå…§å®¹</li>
        <li>ğŸ’¾ <strong>æ¸›å°‘å­˜å„²æµªè²»</strong> - ä¸éœ€è¦çš„éƒ¨åˆ†ä¸æœƒè¢«ç´¢å¼•</li>
    </ul>

    <h3>4.2 Chunking åƒæ•¸</h3>
    <pre>const CHUNK_SIZE = 512;      // tokens per chunk
const CHUNK_OVERLAP = 64;    // overlap between chunks</pre>

    <table>
        <tr>
            <th>åƒæ•¸</th>
            <th>å€¼</th>
            <th>ç†ç”±</th>
        </tr>
        <tr>
            <td>Chunk å¤§å°</td>
            <td>512 tokens</td>
            <td>å¹³è¡¡ä¸Šä¸‹æ–‡é•·åº¦å’Œæª¢ç´¢ç²¾åº¦</td>
        </tr>
        <tr>
            <td>é‡ç–Šå¤§å°</td>
            <td>64 tokens</td>
            <td>é¿å…èªç¾©åœ¨é‚Šç•Œè¢«æˆªæ–·</td>
        </tr>
    </table>

    <h3>4.3 Chunking ç¤ºä¾‹</h3>
    <pre><strong>åŸå§‹å°è©±ï¼ˆ1,200 tokensï¼‰ï¼š</strong>

[0-511]      Chunk #1: "ä½ å¥½ï¼è¨˜äº‹æœ¬ç¤¾åœ˜..."
             â†“ overlap 64 tokens
[448-959]    Chunk #2: "...è²¼æ–‡å…± 31 ç¯‡..."
             â†“ overlap 64 tokens
[896-1200]   Chunk #3: "...å®Œæˆæ•´ç†ã€‚"</pre>

    <h2>äº”ã€Embedding ç”Ÿæˆ</h2>
    <h3>5.1 Gemini Embedding API</h3>
    <pre>POST https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:batchEmbedContents

{
  "requests": [
    {
      "model": "models/gemini-embedding-001",
      "content": {
        "parts": [{"text": "Chunk #1 å…§å®¹..."}]
      }
    }
  ]
}</pre>

    <h3>5.2 è¿”å›å‘é‡</h3>
    <pre>{
  "embeddings": [
    {
      "values": [0.123, -0.456, 0.789, ...] // 768 ç¶­ float32
    }
  ]
}</pre>

    <h3>5.3 æ‰¹æ¬¡ vs å¯¦æ™‚</h3>
    <table>
        <tr>
            <th>æ¨¡å¼</th>
            <th>é€Ÿåº¦</th>
            <th>æˆæœ¬</th>
            <th>é©ç”¨å ´æ™¯</th>
        </tr>
        <tr>
            <td>å¯¦æ™‚ï¼ˆç•¶å‰ï¼‰</td>
            <td>å¿«ï¼ˆç§’ç´šï¼‰</td>
            <td>é«˜</td>
            <td>å³æ™‚æœç´¢</td>
        </tr>
        <tr>
            <td>Batch API</td>
            <td>æ…¢ï¼ˆåˆ†é˜ç´šï¼‰</td>
            <td>ä½ï¼ˆ50% offï¼‰</td>
            <td>æ‰¹é‡ç´¢å¼•</td>
        </tr>
    </table>

    <div class="warning">
        <strong>âš ï¸ ç•¶å‰æœªå•Ÿç”¨ Batch APIï¼š</strong><br>
        å¯¦æ™‚èª¿ç”¨æˆæœ¬è¼ƒé«˜ï¼Œä½†é€Ÿåº¦å¿«ã€‚æœªä¾†å¯è€ƒæ…®å•Ÿç”¨ Batch æ¨¡å¼é™ä½æˆæœ¬ã€‚
    </div>

    <h2>å…­ã€SQLite æ•¸æ“šåº«çµæ§‹</h2>
    <h3>6.1 ä¸‰è¡¨è¨­è¨ˆ</h3>
    <div class="diagram">
        <strong>ğŸ¨ [ç”Ÿåœ– Prompt]:</strong><br>
        A database schema diagram showing 3 tables: "files" (with columns: id, path, lastSize, lastSync), "chunks" (with columns: id, fileId, chunkIndex, text, embedding), and "vec0" (virtual table for vector search). Show relationships between tables with arrows. Use a clean ER diagram style with light blue table headers.
    </div>

    <pre>// 1. files è¡¨ï¼ˆæ–‡ä»¶å…ƒæ•¸æ“šï¼‰
CREATE TABLE files (
  id INTEGER PRIMARY KEY,
  path TEXT UNIQUE,
  lastSize INTEGER,
  lastSync INTEGER
);

// 2. chunks è¡¨ï¼ˆæ–‡æœ¬ç‰‡æ®µï¼‰
CREATE TABLE chunks (
  id INTEGER PRIMARY KEY,
  fileId INTEGER,
  chunkIndex INTEGER,
  text TEXT,
  FOREIGN KEY (fileId) REFERENCES files(id)
);

// 3. vec0 è™›æ“¬è¡¨ï¼ˆå‘é‡ç´¢å¼•ï¼Œä½¿ç”¨ sqlite-vecï¼‰
CREATE VIRTUAL TABLE vec0 USING vec0(
  embedding FLOAT[768]
);

// 4. fts5_chunks è¡¨ï¼ˆå…¨æ–‡æœç´¢ï¼‰
CREATE VIRTUAL TABLE fts5_chunks USING fts5(
  text,
  content=chunks
);</pre>

    <h3>6.2 æ•¸æ“šæ’å…¥æµç¨‹</h3>
    <pre>// Step 1: æ’å…¥æ–‡ä»¶å…ƒæ•¸æ“š
INSERT INTO files (path, lastSize, lastSync)
VALUES ('sessions/main.jsonl', 102400, 1707456000);

// Step 2: æ’å…¥ chunk æ–‡æœ¬
INSERT INTO chunks (fileId, chunkIndex, text)
VALUES (1, 0, 'Chunk #1 å…§å®¹...');

// Step 3: æ’å…¥ embedding å‘é‡
INSERT INTO vec0 (rowid, embedding)
VALUES (1, VECTOR_BLOB([0.123, -0.456, ...]));

// Step 4: æ›´æ–° FTS5 ç´¢å¼•ï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰</pre>

    <h2>ä¸ƒã€æ··åˆæœç´¢ç®—æ³•</h2>
    <h3>7.1 ç‚ºä»€éº¼éœ€è¦æ··åˆæœç´¢ï¼Ÿ</h3>
    <table>
        <tr>
            <th>æœç´¢é¡å‹</th>
            <th>å„ªé»</th>
            <th>ç¼ºé»</th>
        </tr>
        <tr>
            <td><strong>å‘é‡æœç´¢</strong></td>
            <td>èªç¾©ç†è§£å¼·<br>åŒç¾©è©å¯å¬å›</td>
            <td>ç²¾ç¢ºåŒ¹é…å¼±<br>å¯èƒ½æ¼æ‰é—œéµè©</td>
        </tr>
        <tr>
            <td><strong>é—œéµè©æœç´¢</strong></td>
            <td>ç²¾ç¢ºåŒ¹é…å¼·<br>æ€§èƒ½å¿«</td>
            <td>èªç¾©ç†è§£å¼±<br>åŒç¾©è©ç„¡æ³•å¬å›</td>
        </tr>
        <tr>
            <td><strong>æ··åˆæœç´¢</strong></td>
            <td>å…¼é¡§èªç¾©å’Œç²¾ç¢º<br>å¬å›ç‡é«˜</td>
            <td>è¨ˆç®—é‡ç•¥é«˜</td>
        </tr>
    </table>

    <h3>7.2 æœç´¢æ¬Šé‡</h3>
    <pre>const VECTOR_WEIGHT = 0.7;    // 70% å‘é‡æœç´¢
const KEYWORD_WEIGHT = 0.3;   // 30% é—œéµè©æœç´¢</pre>

    <h3>7.3 RRF åˆä½µç®—æ³•</h3>
    <p><strong>RRF (Reciprocal Rank Fusion)</strong> - èåˆå¤šå€‹æ’åºçµæœ</p>
    <pre>function rrfScore(rank: number): number {
  const K = 60;  // å¸¸æ•¸
  return 1 / (K + rank);
}

// ç¤ºä¾‹ï¼š
// å‘é‡æœç´¢çµæœï¼š[Doc A (rank 1), Doc B (rank 2)]
// é—œéµè©çµæœï¼š  [Doc B (rank 1), Doc C (rank 2)]

// Doc A: 0.7 * rrfScore(1) + 0 = 0.0115
// Doc B: 0.7 * rrfScore(2) + 0.3 * rrfScore(1) = 0.0163
// Doc C: 0 + 0.3 * rrfScore(2) = 0.0048

// æœ€çµ‚æ’åºï¼šDoc B > Doc A > Doc C</pre>

    <h2>å…«ã€æœç´¢åŸ·è¡Œæµç¨‹</h2>
    <div class="flowchart">
memory_search("è¨˜äº‹æœ¬ç¤¾åœ˜æœ€æ–°è²¼æ–‡")
    â†“
1. Gemini embedding æŸ¥è©¢æ–‡æœ¬
   â†’ [0.234, -0.567, 0.891, ...]
    â†“
2. å‘é‡æœç´¢ï¼ˆvec0 è¡¨ï¼‰
   SELECT rowid, distance 
   FROM vec0 
   WHERE embedding MATCH ?
   ORDER BY distance 
   LIMIT 10;
   
   çµæœï¼š[Chunk #5, Chunk #12, Chunk #23]
    â†“
3. é—œéµè©æœç´¢ï¼ˆFTS5ï¼‰
   SELECT rowid, rank 
   FROM fts5_chunks 
   WHERE text MATCH 'è¨˜äº‹æœ¬ AND ç¤¾åœ˜'
   ORDER BY rank 
   LIMIT 10;
   
   çµæœï¼š[Chunk #5, Chunk #19]
    â†“
4. RRF åˆä½µ
   Chunk #5:  0.7 * rrfScore(1) + 0.3 * rrfScore(1) = 0.0164
   Chunk #12: 0.7 * rrfScore(2) + 0 = 0.0113
   Chunk #19: 0 + 0.3 * rrfScore(2) = 0.0048
    â†“
5. æ’åº + éæ¿¾ï¼ˆminScore = 0.5ï¼‰
   çµæœï¼š[Chunk #5, Chunk #12]
    â†“
6. è¿”å›çµ¦ AI
   {
     path: "sessions/main.jsonl",
     lines: 125-140,
     snippet: "...è¨˜äº‹æœ¬ç¤¾åœ˜ 31 ç¯‡è²¼æ–‡..."
   }</div>

    <h2>ä¹ã€åŒæ­¥ç­–ç•¥</h2>
    <h3>9.1 ä¸‰ç¨®è§¸ç™¼æ–¹å¼</h3>
    <table>
        <tr>
            <th>è§¸ç™¼æ–¹å¼</th>
            <th>æ™‚æ©Ÿ</th>
            <th>é©ç”¨å ´æ™¯</th>
        </tr>
        <tr>
            <td><strong>onSessionStart</strong></td>
            <td>Gateway å•Ÿå‹•æ™‚</td>
            <td>åˆæ¬¡ç´¢å¼•æ‰€æœ‰ session</td>
        </tr>
        <tr>
            <td><strong>onSearch</strong></td>
            <td>åŸ·è¡Œ memory_search å‰</td>
            <td>ç¢ºä¿æœç´¢å‰æ•¸æ“šæœ€æ–°</td>
        </tr>
        <tr>
            <td><strong>watch</strong></td>
            <td>æ–‡ä»¶è®Šæ›´æ™‚ï¼ˆå¯¦æ™‚ï¼‰</td>
            <td>è‡ªå‹•å¢é‡ç´¢å¼•</td>
        </tr>
    </table>

    <h3>9.2 ç•¶å‰é…ç½®</h3>
    <pre>{
  "experimental": {
    "sessionMemory": {
      "enabled": true,
      "syncStrategy": "watch"  // å¯¦æ™‚ç›£è½
    }
  }
}</pre>

    <h2>åã€æ€§èƒ½èˆ‡æˆæœ¬åˆ†æ</h2>
    <h3>10.1 Embedding æˆæœ¬</h3>
    <pre><strong>Gemini Embedding API å…è²»é¡åº¦ï¼š</strong>
â€¢ 1,500 æ¬¡è«‹æ±‚/åˆ†é˜
â€¢ 100,000 æ¬¡è«‹æ±‚/å¤©

<strong>å¯¦éš›æ¶ˆè€—ï¼ˆä¼°ç®—ï¼‰ï¼š</strong>
â€¢ 1 å€‹ sessionï¼ˆ1 MBï¼‰â†’ ~100 chunks â†’ 100 æ¬¡ API èª¿ç”¨
â€¢ æ¯æ¬¡æœç´¢ â†’ 1 æ¬¡ API èª¿ç”¨

<strong>è€å¤§ç•¶å‰ç‹€æ…‹ï¼š</strong>
â€¢ 10 å€‹ session æ–‡ä»¶ â†’ ~1,000 æ¬¡ API èª¿ç”¨ï¼ˆåˆæ¬¡ç´¢å¼•ï¼‰
â€¢ æ¯å¤©æœç´¢ ~50 æ¬¡ â†’ 50 æ¬¡ API èª¿ç”¨
â€¢ ç¸½è¨ˆï¼šé ä½æ–¼å…è²»é¡åº¦</pre>

    <h3>10.2 å­˜å„²ç©ºé–“</h3>
    <pre>1 å€‹ chunkï¼š
â€¢ æ–‡æœ¬ï¼š~2 KB
â€¢ Embeddingï¼ˆ768 ç¶­ float32ï¼‰ï¼š~3 KB
â€¢ FTS5 ç´¢å¼•ï¼š~1 KB
â€¢ ç¸½è¨ˆï¼š~6 KB/chunk

è€å¤§ç•¶å‰ï¼ˆä¼°ç®—ï¼‰ï¼š
â€¢ 10 å€‹ session â†’ ~1,000 chunks
â€¢ æ•¸æ“šåº«å¤§å°ï¼š~6 MB</pre>

    <h3>10.3 ç´¢å¼•é€Ÿåº¦</h3>
    <table>
        <tr>
            <th>æ•¸æ“šé‡</th>
            <th>ç´¢å¼•æ™‚é–“</th>
            <th>å‚™è¨»</th>
        </tr>
        <tr>
            <td>100 æ¢å°è©±</td>
            <td>5-10 ç§’</td>
            <td>å¯¦æ™‚ embedding</td>
        </tr>
        <tr>
            <td>1,000 æ¢å°è©±</td>
            <td>30-60 ç§’</td>
            <td>Delta è¿½è¸ªè§¸ç™¼</td>
        </tr>
        <tr>
            <td>10,000 æ¢å°è©±</td>
            <td>5-10 åˆ†é˜</td>
            <td>åˆæ¬¡ç´¢å¼•ï¼ˆonSessionStartï¼‰</td>
        </tr>
    </table>

    <h2>åä¸€ã€æ½›åœ¨å„ªåŒ–é»</h2>
    <div class="warning">
        <strong>âš ï¸ å¾…è¨è«–çš„æ”¹é€²æ–¹å‘ï¼š</strong>
    </div>

    <h3>11.1 Sub-agent ç„¡æ³•ä½¿ç”¨ Session Search</h3>
    <p><strong>å•é¡Œï¼š</strong> ç•¶å‰ <code>isMinimal = true</code> æ™‚ï¼ŒMemory Recall å€å¡Šè¢«è·³é</p>
    <p><strong>å½±éŸ¿ï¼š</strong> Sub-agent ç„¡æ³•åˆ©ç”¨æ­·å²å°è©±ä¸Šä¸‹æ–‡</p>
    <p><strong>æ½›åœ¨æ–¹æ¡ˆï¼š</strong></p>
    <ul>
        <li>æ–°å¢ "semi-minimal" æ¨¡å¼ï¼ˆä¿ç•™ Memory Recallï¼‰</li>
        <li>å…è¨± Sub-agent æŒ‰éœ€è¼‰å…¥ Memory Recall</li>
    </ul>

    <h3>11.2 Delta é–¾å€¼å¯èƒ½å¤ªå¤§</h3>
    <p><strong>å•é¡Œï¼š</strong> 8 KB â‰ˆ 100-200 æ¢å°è©±ï¼Œå»¶é²è¼ƒé•·</p>
    <p><strong>å½±éŸ¿ï¼š</strong> æ–°å°è©±éœ€è¦ç©ç´¯è¼ƒå¤šæ‰æœƒè¢«ç´¢å¼•</p>
    <p><strong>æ½›åœ¨æ–¹æ¡ˆï¼š</strong></p>
    <ul>
        <li>é™ä½é–¾å€¼åˆ° 4 KB æˆ– 2 KB</li>
        <li>æ”¹ç‚ºæ¢æ•¸åˆ¤æ–·ï¼ˆ>= 50 æ¢æ¶ˆæ¯ï¼‰</li>
    </ul>

    <h3>11.3 æ²’æœ‰ Session å¹´é½¡ç®¡ç†</h3>
    <p><strong>å•é¡Œï¼š</strong> èˆŠ session æœƒæ°¸ä¹…å­˜åœ¨æ•¸æ“šåº«</p>
    <p><strong>å½±éŸ¿ï¼š</strong> æ•¸æ“šåº«æŒçºŒå¢é•·ï¼Œæœç´¢å¯èƒ½è®Šæ…¢</p>
    <p><strong>æ½›åœ¨æ–¹æ¡ˆï¼š</strong></p>
    <ul>
        <li>æ·»åŠ  TTLï¼ˆTime-To-Liveï¼‰æ©Ÿåˆ¶</li>
        <li>è‡ªå‹•æ­¸æª”è¶…é N å¤©çš„ session</li>
        <li>æ‰‹å‹•æ¸…ç†èˆŠ session çš„å‘½ä»¤</li>
    </ul>

    <h3>11.4 Batch API æœªå•Ÿç”¨</h3>
    <p><strong>å•é¡Œï¼š</strong> ç•¶å‰å¯¦æ™‚èª¿ç”¨ï¼Œæˆæœ¬è¼ƒé«˜</p>
    <p><strong>å½±éŸ¿ï¼š</strong> å¤§é‡ç´¢å¼•æ™‚ API èª¿ç”¨é‡å¤§</p>
    <p><strong>æ½›åœ¨æ–¹æ¡ˆï¼š</strong></p>
    <ul>
        <li>å•Ÿç”¨ Gemini Batch Embedding APIï¼ˆ50% offï¼‰</li>
        <li>éç·Šæ€¥ç´¢å¼•æ”¹ç”¨æ‰¹æ¬¡æ¨¡å¼</li>
    </ul>

    <h2>åäºŒã€ç¸½çµ</h2>
    <div class="success">
        <strong>âœ… Session Search æ ¸å¿ƒè¦é»ï¼š</strong>
        <ul>
            <li>âœ… äº‹ä»¶é©…å‹•ï¼šSession æ›´æ–°è‡ªå‹•è§¸ç™¼</li>
            <li>âœ… Delta è¿½è¹¤ï¼šå¢é‡ç´¢å¼•ï¼ˆ>= 8KBï¼‰</li>
            <li>âœ… Chunkingï¼š512 tokens/å¡Š + 64 tokens é‡ç–Š</li>
            <li>âœ… Gemini Embeddingï¼š768 ç¶­å‘é‡</li>
            <li>âœ… SQLite å­˜å„²ï¼šchunks + vec0 + FTS5</li>
            <li>âœ… æ··åˆæœç´¢ï¼š70% å‘é‡ + 30% é—œéµè©</li>
            <li>âœ… RRF åˆä½µï¼šå…¼é¡§èªç¾©å’Œç²¾ç¢ºåŒ¹é…</li>
        </ul>
    </div>

    <hr style="margin: 40px 0; border: none; border-top: 2px solid #ecf0f1;">
    <p style="text-align: center; color: #7f8c8d; font-size: 0.9em;">
        ğŸ“š Memory Recall ç³»åˆ—æ–‡æª” 4/4ï¼ˆå®Œçµï¼‰<br>
        ä¸Šä¸€ç¯‡ï¼š<a href="memoryRecall_sessions.html">Sessions æœç´¢æ©Ÿåˆ¶</a><br>
        è¿”å›ï¼š<a href="memoryRecall_overview.html">ç³»çµ±æ¦‚è¦½</a>
    </p>
</body>
</html>
